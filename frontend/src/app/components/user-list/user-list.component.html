<h1 class="h4 mb-4">Cadastro de usuários</h1>
@if (error()) {
  <div class="alert alert-danger py-2 mb-3">{{ error() }}</div>
}
@if (loading()) {
  <div class="text-center py-4"><span class="spinner-border spinner-border-sm"></span> Carregando...</div>
} @else {
  <div class="row g-4">
    <div class="col-md-5 col-lg-4">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-semibold">Usuários</span>
          <button type="button" class="btn btn-primary btn-sm" (click)="newUser()">Novo</button>
        </div>
        <ul class="list-group list-group-flush">
          @for (u of users(); track u.id) {
            <li class="list-group-item list-group-item-action cursor-pointer d-flex justify-content-between align-items-center" (click)="select(u)" [class.active]="selected()?.id === u.id">
              <div>
                <span class="fw-medium">{{ u.name }}</span><br />
                <small class="text-muted">{{ u.username }} — {{ u.role }}</small>
              </div>
              @if (authService.user()?.username !== u.username) {
                <button type="button" class="btn btn-outline-danger btn-sm" (click)="openDeleteConfirm(u); $event.stopPropagation()" title="Excluir usuário">Excluir</button>
              }
            </li>
          }
        </ul>
      </div>
    </div>
    <div class="col-md-7 col-lg-6">
      <div class="card">
        <div class="card-header">{{ editMode() ? 'Editar usuário' : 'Novo usuário' }}</div>
        <div class="card-body">
          <form (ngSubmit)="save()">
            <div class="mb-3">
              <label class="form-label">Nome (máx. 30)</label>
              <input type="text" class="form-control" [ngModel]="form().name" (ngModelChange)="updateName($event)" name="name" maxlength="30" />
            </div>
            <div class="mb-3">
              <label class="form-label">Usuário (máx. 15)</label>
              <input type="text" class="form-control" [ngModel]="form().username" (ngModelChange)="updateUsername($event)" name="username" maxlength="15" [readonly]="!!selected()" />
            </div>
            <div class="mb-3">
              <label class="form-label">Senha (máx. 10) {{ editMode() ? '(deixe em branco para não alterar)' : '' }}</label>
              <input type="password" class="form-control" [(ngModel)]="form().password" name="password" maxlength="10" />
            </div>
            <div class="mb-3">
              <label class="form-label">Perfil</label>
              <select class="form-select" [(ngModel)]="form().role" name="role">
                <option value="USER">USER</option>
                <option value="ADMIN">ADMIN</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">Salvar</button>
          </form>
        </div>
      </div>
    </div>
  </div>
}

@if (showDeleteModal()) {
  <div class="modal d-block" tabindex="-1" role="dialog" style="background: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar exclusão</h5>
          <button type="button" class="btn-close" (click)="closeDeleteConfirm()" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">
            <br>
            Esta operação irá excluir o usuário <strong>{{ userToDelete()?.name }} - ({{ userToDelete()?.role }})</strong>
            e todos os arquivos carregados, incluindo os realizados em documento de outros usuários.<br>
            <br>
            Deseja prosseguir?
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeDeleteConfirm()">Cancelar</button>
          <button type="button" class="btn btn-danger" (click)="confirmDelete()">Confirmar</button>
        </div>
      </div>
    </div>
  </div>
}
